#!/usr/bin/env node

// This script:
// - Reads the shared project config from the `kindConfig` key in the project's package.json
// - Uses that data to set a local nanobox DNS alias for the CraftCMS install
// - and environment variables (via .env) for
// -- ASSET_SERVER_PORT
// -- FRACTAL_SERVER_PORT
// -- DEFAULT_SITE_URL
// -- SITE_NAME

const util = require("util");
const fs = require("fs");
const path = require("path");
const exec = util.promisify(require("child_process").exec);
require("colors");


const toDotEnvString = require("../lib/toDotEnvString");

const pkg = require("./../../package.json");

const dotEnvPath = path.resolve(__dirname, "../../.env");
const dotEnvExamplePath = path.resolve(__dirname, "../../.env.example");

if (!pkg.kindConfig) {
  console.error("Error: looks like this project hasn't been configured yet, is this a new project?".red);
  console.error("Is this a new project? If so you should run `yarn project:configure` first".yellow);
  process.exit();
}

async function applyLocalDnsAlias() {
  const cmd = `nanobox dns add local ${pkg.kindConfig.craftDomain}`;

  const { stdout, stderr } = await exec(cmd);
  console.log(stdout, stderr);

  if (!stderr) {
    console.log("Added local DNS alias".green);
  }
}

function setEnvvars() {
  const output = toDotEnvString({
    assetServerPort: pkg.kindConfig.ports.assets,
    fractalServerPort: pkg.kindConfig.ports.fractal,
    defaultSiteUrl: pkg.kindConfig.craftDomain,
    siteName: pkg.kindConfig.siteName,
    adminEmail: pkg.kindConfig.adminEmail,
  });


  fs.appendFileSync(dotEnvExamplePath, '\r\n# GENERATED BY APPLY ENV\r\n', (err) => {
    console.log('err', err);
  });

  fs.appendFileSync(dotEnvExamplePath, output, (err) => {
    console.log('err', err);
  });

  fs.appendFileSync(dotEnvExamplePath, '\r\n# GENERATED BY APPLY ENV\r\n', (err) => {
    console.log('err', err);
  });
  fs.appendFileSync(dotEnvPath, output, (err) => {
    console.log('err', err);
  });

  console.log("Configured environment variables".green);
}


function applyEnv() {
  applyLocalDnsAlias();
  setEnvvars();
}

applyEnv();





