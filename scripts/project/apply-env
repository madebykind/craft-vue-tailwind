#!/usr/bin/env node
const util = require("util");
const fs = require("fs");
const path = require("path");
const exec = util.promisify(require("child_process").exec);
require("colors");


const toDotEnvString = require("../lib/toDotEnvString");

const pkg = require("./../../package.json");

const dotEnvPath = path.resolve(__dirname, "../../.env");
const dotEnvExamplePath = path.resolve(__dirname, "../../.env.example");

if (!pkg.kindConfig) {
  console.error("Error: looks like this project hasn't been configured yet".red);
  process.exit();
}

async function applyLocalDnsAlias() {
  const cmd = `nanobox dns add local ${pkg.kindConfig.craftDomain}`;

  const { stdout, stderr } = await exec(cmd);
  console.log(stdout, stderr);

  if (!stderr) {
    console.log("Added local DNS alias".green);
  }
}

function setEnvvars() {
  const output = toDotEnvString({
    assetServerPort: pkg.kindConfig.ports.assets,
    fractalServerPort: pkg.kindConfig.ports.fractal,
    siteHostname: pkg.kindConfig.craftDomain,
    siteName: pkg.kindConfig.siteName,
  });


  fs.appendFileSync(dotEnvExamplePath, '\r\n# GENERATED BY APPLY ENV\r\n', (err) => {
    console.log('err', err);
  });

  fs.appendFileSync(dotEnvExamplePath, output, (err) => {
    console.log('err', err);
  });

  fs.appendFileSync(dotEnvPath, output, (err) => {
    console.log('err', err);
  });

  console.log("Configured environment variables".green);
}


function applyEnv() {
  applyLocalDnsAlias();
  setEnvvars();
}

applyEnv();





